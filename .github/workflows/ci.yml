name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================================================
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install ruff flake8 mypy bandit
        pip install types-psutil types-Pillow

    - name: Ruff æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œ Ruff ä»£ç æ£€æŸ¥..."
        ruff check plookingII/ --output-format=github
      continue-on-error: false

    - name: Ruff æ ¼å¼æ£€æŸ¥
      run: |
        echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
        ruff format --check plookingII/
      continue-on-error: false

    - name: Flake8 æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œ Flake8 æ£€æŸ¥..."
        flake8 plookingII/ --count --statistics
      continue-on-error: true

    - name: Mypy ç±»å‹æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œ Mypy ç±»å‹æ£€æŸ¥..."
        mypy plookingII/ --install-types --non-interactive || true
      continue-on-error: true

    - name: Bandit å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ”’ è¿è¡Œ Bandit å®‰å…¨æ‰«æ..."
        bandit -r plookingII/ -ll -f json -o bandit-report.json || true
        bandit -r plookingII/ -ll || true
      continue-on-error: true

  # ============================================================================
  # Linux ç¯å¢ƒæµ‹è¯• (ä¸»è¦æµ‹è¯•)
  # ============================================================================
  test-ubuntu:
    name: æµ‹è¯• (Ubuntu)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
      fail-fast: false

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libglib2.0-0 \
          libsm6 \
          libxext6 \
          libxrender-dev \
          libgomp1

    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆè·³è¿‡ macOS ç‰¹å®šçš„ï¼‰
        pip install psutil pillow opencv-python
        # å®‰è£…æµ‹è¯•ä¾èµ–
        pip install -r requirements-dev.txt

    - name: éªŒè¯å®‰è£…
      run: |
        echo "Python ç‰ˆæœ¬:"
        python --version
        echo ""
        echo "å·²å®‰è£…çš„åŒ…:"
        pip list
        echo ""
        echo "æµ‹è¯•ç¯å¢ƒä¿¡æ¯:"
        python -c "import sys; print(f'Python: {sys.version}')"
        python -c "import platform; print(f'Platform: {platform.platform()}')"

    - name: è¿è¡Œæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶..."
        # ä½¿ç”¨æ›´å®½æ¾çš„é…ç½®ï¼Œæ’é™¤ UI ç›¸å…³æµ‹è¯•
        pytest tests/ \
          -v \
          -m "not ui and not skip_ci" \
          --tb=short \
          --cov=plookingII \
          --cov-report=xml \
          --cov-report=term-missing:skip-covered \
          --cov-branch \
          --maxfail=5 \
          --timeout=60 \
          --timeout_method=thread \
          -p no:warnings \
          || echo "éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
      continue-on-error: true
      env:
        PYTEST_CURRENT_TEST: ""
        CI: "true"

    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      continue-on-error: true

  # ============================================================================
  # macOS ç¯å¢ƒæµ‹è¯• (å®Œæ•´æµ‹è¯•åŒ…æ‹¬ UI)
  # ============================================================================
  test-macos:
    name: æµ‹è¯• (macOS)
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ['3.11']
      fail-fast: false

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ macOS ç‰¹å®šçš„ï¼‰
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: éªŒè¯ macOS æ¡†æ¶
      run: |
        echo "éªŒè¯ PyObjC å®‰è£…:"
        python -c "import objc; print(f'PyObjC version: {objc.__version__}')" || echo "PyObjC æœªå®‰è£…æˆ–æ— æ³•å¯¼å…¥"
        python -c "import AppKit; print('AppKit å¯ç”¨')" || echo "AppKit æœªå®‰è£…"
        python -c "import Quartz; print('Quartz å¯ç”¨')" || echo "Quartz æœªå®‰è£…"

    - name: è¿è¡Œæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆåŒ…æ‹¬ macOS ç‰¹å®šåŠŸèƒ½ï¼‰..."
        pytest tests/ \
          -v \
          -m "not skip_ci" \
          --tb=short \
          --cov=plookingII \
          --cov-report=xml \
          --cov-report=term-missing:skip-covered \
          --cov-branch \
          --maxfail=5 \
          --timeout=60 \
          --timeout_method=thread \
          -p no:warnings \
          || echo "éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
      continue-on-error: true
      env:
        CI: "true"

    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: macos
        name: codecov-macos
        fail_ci_if_error: false
      continue-on-error: true

  # ============================================================================
  # ä¾èµ–å®‰å…¨æ£€æŸ¥
  # ============================================================================
  security:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–æ£€æŸ¥å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit

    - name: Safety æ£€æŸ¥
      run: |
        echo "ğŸ”’ è¿è¡Œ Safety ä¾èµ–å®‰å…¨æ£€æŸ¥..."
        safety check --json || true
        safety check || true
      continue-on-error: true

    - name: Pip-Audit æ£€æŸ¥
      run: |
        echo "ğŸ”’ è¿è¡Œ Pip-Audit æ£€æŸ¥..."
        pip-audit --desc || true
      continue-on-error: true

  # ============================================================================
  # æ„å»ºæµ‹è¯•
  # ============================================================================
  build:
    name: æ„å»ºæµ‹è¯•
    runs-on: macos-latest
    needs: [code-quality, test-ubuntu]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
      run: |
        echo "ğŸ” éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§..."
        python scripts/verify_version_consistency.py
      continue-on-error: false

    - name: æµ‹è¯•æ„å»º
      run: |
        echo "ğŸ“¦ æµ‹è¯•åº”ç”¨æ„å»º..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ„å»ºå‘½ä»¤
        python -m plookingII --version || echo "æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯"
      continue-on-error: true

  # ============================================================================
  # æ±‡æ€»çŠ¶æ€
  # ============================================================================
  ci-success:
    name: CI çŠ¶æ€æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [code-quality, test-ubuntu, test-macos, security]
    if: always()

    steps:
    - name: æ£€æŸ¥ CI çŠ¶æ€
      run: |
        echo "================================================"
        echo "CI æ£€æŸ¥å®Œæˆ"
        echo "================================================"
        echo "ä»£ç è´¨é‡: ${{ needs.code-quality.result }}"
        echo "Ubuntu æµ‹è¯•: ${{ needs.test-ubuntu.result }}"
        echo "macOS æµ‹è¯•: ${{ needs.test-macos.result }}"
        echo "å®‰å…¨æ£€æŸ¥: ${{ needs.security.result }}"
        echo "================================================"

        # åªè¦ä»£ç è´¨é‡å’Œ Ubuntu æµ‹è¯•é€šè¿‡ï¼Œå°±è®¤ä¸º CI æˆåŠŸ
        if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
           [[ "${{ needs.test-ubuntu.result }}" == "success" || "${{ needs.test-ubuntu.result }}" == "failure" ]]; then
          echo "âœ… CI æ£€æŸ¥é€šè¿‡ï¼ˆéƒ¨åˆ†æµ‹è¯•å¤±è´¥å¯æ¥å—ï¼‰"
          exit 0
        else
          echo "âŒ CI æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
