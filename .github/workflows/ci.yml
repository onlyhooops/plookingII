name: CI - æŒç»­é›†æˆ

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ
  - cron: 0 0 * * *

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: v1

jobs:
  # ============================================================================
  # ç‰ˆæœ¬å·ä¸€è‡´æ€§éªŒè¯
  # ============================================================================
  version-check:
    name: ç‰ˆæœ¬å·ä¸€è‡´æ€§éªŒè¯
    runs-on: macos-latest
    timeout-minutes: 5

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§
      timeout-minutes: 2
      run: |
        python3 scripts/verify_version_consistency.py

    - name: ç‰ˆæœ¬ä¿¡æ¯æ‘˜è¦
      if: always()
      run: |
        VERSION=$(python3 -c "import sys; sys.path.insert(0, 'plookingII'); from config.constants import VERSION; print(VERSION)")
        echo "## ðŸ“Œ ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **å½“å‰ç‰ˆæœ¬**: $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **éªŒè¯çŠ¶æ€**: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================================================
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: macos-latest
    timeout-minutes: 10

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: pip

    - name: å®‰è£…ä¾èµ–
      timeout-minutes: 5
      run: |
        python -m pip install --upgrade pip
        pip install ruff flake8 flake8-bugbear flake8-comprehensions

    - name: Ruffæ£€æŸ¥
      timeout-minutes: 3
      run: |
        ruff check plookingII/ --output-format=github

    - name: Ruffæ ¼å¼æ£€æŸ¥
      timeout-minutes: 2
      run: |
        ruff format --check plookingII/

  # ============================================================================
  # ç±»åž‹æ£€æŸ¥
  # ============================================================================
  type-check:
    name: ç±»åž‹æ£€æŸ¥
    runs-on: macos-latest
    timeout-minutes: 10

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: pip

    - name: å®‰è£…ä¾èµ–
      timeout-minutes: 5
      run: |
        python -m pip install --upgrade pip
        pip install mypy types-psutil types-Pillow
        pip install -r requirements.txt

    - name: MyPyç±»åž‹æ£€æŸ¥
      timeout-minutes: 5
      run: |
        mypy plookingII/ --config-file=mypy.ini --no-error-summary || true

  # ============================================================================
  # å®‰å…¨æ£€æŸ¥
  # ============================================================================
  security:
    name: å®‰å…¨æ‰«æ
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: pip

    - name: å®‰è£…ä¾èµ–
      timeout-minutes: 5
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        pip install -r requirements.txt

    - name: Banditå®‰å…¨æ‰«æ
      timeout-minutes: 5
      run: |
        bandit -r plookingII/ -f json -o bandit-report.json || true
        bandit -r plookingII/ -f screen
      continue-on-error: true

    - name: Safetyä¾èµ–æ‰«æ
      timeout-minutes: 5
      run: |
        safety check --json || true
      continue-on-error: true

    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: bandit-report.json
        retention-days: 30

  # ============================================================================
  # å•å…ƒæµ‹è¯•
  # ============================================================================
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: macos-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      timeout-minutes: 5
      run: |
        # macOSé€šå¸¸å·²ç»æœ‰å¿…è¦çš„åº“
        echo "macOS ç³»ç»Ÿä¾èµ–æ£€æŸ¥å®Œæˆ"

    - name: å®‰è£…Pythonä¾èµ–
      timeout-minutes: 10
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      timeout-minutes: 20
      run: |
        pytest tests/unit/ \
          --timeout=300 \
          --timeout-method=thread \
          -v \
          --tb=short \
          --maxfail=5 \
          --cov=plookingII \
          --cov-report=xml \
          --cov-report=term-missing \
          --durations=10
      env:
        CI: true

    - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      timeout-minutes: 3

  # ============================================================================
  # é›†æˆæµ‹è¯•
  # ============================================================================
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: macos-latest
    timeout-minutes: 45
    needs: [unit-tests]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: pip

    - name: å®‰è£…ä¾èµ–
      timeout-minutes: 10
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: è¿è¡Œé›†æˆæµ‹è¯•
      timeout-minutes: 30
      run: |
        pytest tests/integration/ \
          --timeout=600 \
          --timeout-method=thread \
          -v \
          --tb=short \
          --maxfail=3 \
          --cov=plookingII \
          --cov-report=xml \
          --cov-append
      env:
        CI: true

  # ============================================================================
  # å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆåŒ…æ‹¬æ…¢æµ‹è¯•ï¼‰
  # ============================================================================
  full-test-suite:
    name: å®Œæ•´æµ‹è¯•å¥—ä»¶
    runs-on: macos-latest
    timeout-minutes: 90
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[full-test]')

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: pip

    - name: å®‰è£…ä¾èµ–
      timeout-minutes: 10
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
      timeout-minutes: 75
      run: |
        pytest tests/ \
          --run-slow \
          --timeout=1800 \
          --timeout-method=thread \
          -v \
          --tb=short \
          --cov=plookingII \
          --cov-report=xml \
          --cov-report=html \
          --durations=20
      env:
        CI: true

    - name: ä¸Šä¼ å®Œæ•´è¦†ç›–çŽ‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-full
        path: htmlcov/
        retention-days: 30

  # ============================================================================
  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  # ============================================================================
  test-summary:
    name: æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
    runs-on: macos-latest
    timeout-minutes: 5
    needs: [version-check, code-quality, type-check, security, unit-tests, integration-tests]
    if: always()

    steps:
    - name: ç”Ÿæˆæµ‹è¯•æ‘˜è¦
      run: |
        echo "## æµ‹è¯•ç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- ç‰ˆæœ¬å·éªŒè¯: ${{ needs.version-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ç±»åž‹æ£€æŸ¥: ${{ needs.type-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- å®‰å…¨æ‰«æ: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- å•å…ƒæµ‹è¯•: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- é›†æˆæµ‹è¯•: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
