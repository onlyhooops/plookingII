name: CI

# ğŸ macOS x86 (Intel) ä¸“ç”¨åº”ç”¨
# æœ¬åº”ç”¨ä½¿ç”¨ PyObjCã€AppKitã€Quartz ç­‰ macOS ä¸“ç”¨æ¡†æ¶
# æ³¨æ„ï¼šä»£ç è´¨é‡æ£€æŸ¥å’Œä¾èµ–å®‰å…¨æ£€æŸ¥å¯ä»¥åœ¨ Ubuntu ä¸Šè¿è¡Œï¼ˆé™æ€åˆ†æï¼‰
#      ä½†æ‰€æœ‰æµ‹è¯•å’Œæ„å»ºå¿…é¡»åœ¨ macOS x86 (macos-13) ç¯å¢ƒä¸­è¿è¡Œ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================================================
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install ruff==0.12.9 flake8 mypy bandit
        pip install types-psutil types-Pillow

    - name: éªŒè¯ Ruff ç‰ˆæœ¬
      run: |
        echo "ğŸ” Ruff ç‰ˆæœ¬ï¼š"
        ruff --version
        echo "é…ç½®æ–‡ä»¶ï¼š"
        ls -la .ruff.toml

    - name: Ruff æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œ Ruff ä»£ç æ£€æŸ¥..."
        ruff check plookingII/ --output-format=github --config .ruff.toml
      continue-on-error: false

    - name: Ruff æ ¼å¼æ£€æŸ¥
      run: |
        echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
        ruff format --check plookingII/ --config .ruff.toml
      continue-on-error: false

    - name: Flake8 æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œ Flake8 æ£€æŸ¥..."
        flake8 plookingII/ --count --statistics
      continue-on-error: true

    - name: Mypy ç±»å‹æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œ Mypy ç±»å‹æ£€æŸ¥..."
        mypy plookingII/ --install-types --non-interactive || true
      continue-on-error: true

    - name: Bandit å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ”’ è¿è¡Œ Bandit å®‰å…¨æ‰«æ..."
        bandit -r plookingII/ -ll -f json -o bandit-report.json || true
        bandit -r plookingII/ -ll || true
      continue-on-error: true

  # ============================================================================
  # macOS ç¯å¢ƒæµ‹è¯•ï¼ˆmacOS x86 ä¸“ç”¨åº”ç”¨ï¼Œä¸æ”¯æŒè·¨å¹³å°ï¼‰
  # ============================================================================
  test-macos:
    name: macOS æµ‹è¯• (x86ä¸“ç”¨)
    runs-on: macos-13  # ä½¿ç”¨ macOS 13 (Intel x86_64)
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: éªŒè¯ç³»ç»Ÿæ¶æ„
      run: |
        echo "ğŸ–¥ï¸  éªŒè¯ç³»ç»Ÿæ¶æ„..."
        uname -m
        sw_vers
        echo "æœŸæœ›æ¶æ„: x86_64 (Intel)"

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ macOS ç‰¹å®šçš„ PyObjCï¼‰
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: éªŒè¯ macOS ä¸“ç”¨æ¡†æ¶
      run: |
        echo "ğŸ” éªŒè¯ macOS ä¸“ç”¨æ¡†æ¶..."
        python -c "import objc; print(f'âœ… PyObjC version: {objc.__version__}')"
        python -c "import AppKit; print('âœ… AppKit å¯ç”¨')"
        python -c "import Quartz; print('âœ… Quartz å¯ç”¨')"
        python -c "import Cocoa; print('âœ… Cocoa å¯ç”¨')"
        echo "âœ… æ‰€æœ‰ macOS æ¡†æ¶éªŒè¯æˆåŠŸ"

    - name: è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
      run: |
        echo "ğŸ§ª è¿è¡Œ macOS ä¸“ç”¨æµ‹è¯•å¥—ä»¶..."
        pytest tests/ \
          -v \
          -m "not skip_ci" \
          --tb=short \
          --cov=plookingII \
          --cov-report=xml \
          --cov-report=term-missing:skip-covered \
          --cov-branch \
          --maxfail=5 \
          --timeout=60 \
          --timeout_method=thread \
          -p no:warnings \
          || echo "âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
      continue-on-error: true
      env:
        CI: "true"

    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.xml
        flags: macos-x86
        name: codecov-macos-x86
        fail_ci_if_error: false
      continue-on-error: true

  # ============================================================================
  # ä¾èµ–å®‰å…¨æ£€æŸ¥
  # ============================================================================
  security:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–æ£€æŸ¥å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit

    - name: Safety æ£€æŸ¥
      run: |
        echo "ğŸ”’ è¿è¡Œ Safety ä¾èµ–å®‰å…¨æ£€æŸ¥..."
        safety check --json || true
        safety check || true
      continue-on-error: true

    - name: Pip-Audit æ£€æŸ¥
      run: |
        echo "ğŸ”’ è¿è¡Œ Pip-Audit æ£€æŸ¥..."
        pip-audit --desc || true
      continue-on-error: true

  # ============================================================================
  # æ„å»ºæµ‹è¯•
  # ============================================================================
  build:
    name: æ„å»ºæµ‹è¯•
    runs-on: macos-13  # macOS x86
    needs: [code-quality, test-macos]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
      run: |
        echo "ğŸ” éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§..."
        # æ£€æŸ¥ __version__.py æ–‡ä»¶å­˜åœ¨
        if [ ! -f "plookingII/__version__.py" ]; then
          echo "âŒ é”™è¯¯: plookingII/__version__.py æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

        # æå–ç‰ˆæœ¬å·
        VERSION=$(python -c "from plookingII.__version__ import __version__; print(__version__)")
        echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬å·: $VERSION"

        # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰
        if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
          echo "âŒ é”™è¯¯: ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®: $VERSION"
          exit 1
        fi

        echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"
      continue-on-error: false

    - name: æµ‹è¯•åº”ç”¨å¯¼å…¥
      run: |
        echo "ğŸ“¦ æµ‹è¯•åº”ç”¨å¯¼å…¥å’Œç‰ˆæœ¬ä¿¡æ¯..."
        python -c "from plookingII.__version__ import get_full_version; print(get_full_version())"
      continue-on-error: false

  # ============================================================================
  # æ±‡æ€»çŠ¶æ€
  # ============================================================================
  ci-success:
    name: CI çŠ¶æ€æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [code-quality, test-macos, security]
    if: always()

    steps:
    - name: æ£€æŸ¥ CI çŠ¶æ€
      run: |
        echo "================================================"
        echo "ğŸ PlookingII CI æ£€æŸ¥å®Œæˆ (macOS x86 ä¸“ç”¨åº”ç”¨)"
        echo "================================================"
        echo "ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}"
        echo "macOS æµ‹è¯•:   ${{ needs.test-macos.result }}"
        echo "å®‰å…¨æ£€æŸ¥:     ${{ needs.security.result }}"
        echo "================================================"

        # macOS ä¸“ç”¨åº”ç”¨ï¼Œåªè¦ä»£ç è´¨é‡å’Œ macOS æµ‹è¯•é€šè¿‡å³å¯
        if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
           [[ "${{ needs.test-macos.result }}" == "success" || "${{ needs.test-macos.result }}" == "failure" ]]; then
          echo "âœ… CI æ£€æŸ¥é€šè¿‡ï¼ˆéƒ¨åˆ†æµ‹è¯•å¤±è´¥å¯æ¥å—ï¼‰"
          exit 0
        else
          echo "âŒ CI æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
