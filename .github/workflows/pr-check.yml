name: PR å¿«é€Ÿæ£€æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]

# åªå…è®¸ä¸€ä¸ª workflow è¿è¡Œåœ¨åŒä¸€ä¸ª PR ä¸Š
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  quick-check:
    name: å¿«é€Ÿä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…æ£€æŸ¥å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install ruff

    - name: ğŸ” Ruff å¿«é€Ÿæ£€æŸ¥
      run: |
        echo "è¿è¡Œ Ruff ä»£ç æ£€æŸ¥..."
        ruff check plookingII/ --output-format=github

    - name: ğŸ” Ruff æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
        ruff format --check plookingII/

    - name: ğŸ“ æ£€æŸ¥ç»“æœ
      if: always()
      run: |
        echo "âœ… PR å¿«é€Ÿæ£€æŸ¥å®Œæˆ"

  basic-test:
    name: åŸºç¡€æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq libgl1-mesa-glx libglib2.0-0
        python -m pip install --upgrade pip
        pip install psutil pillow opencv-python pytest pytest-timeout pytest-cov

    - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "è¿è¡Œå¿«é€Ÿå•å…ƒæµ‹è¯•..."
        pytest tests/unit/ \
          -v \
          -m "not slow and not ui and not skip_ci" \
          --tb=line \
          --maxfail=3 \
          --timeout=30 \
          -p no:warnings \
          || echo "éƒ¨åˆ†æµ‹è¯•å¤±è´¥"
      continue-on-error: true

    - name: ğŸ“ æµ‹è¯•ç»“æœ
      if: always()
      run: |
        echo "âœ… åŸºç¡€æµ‹è¯•å®Œæˆ"

  pr-info:
    name: PR ä¿¡æ¯
    runs-on: ubuntu-latest
    steps:
    - name: æ˜¾ç¤º PR ä¿¡æ¯
      run: |
        echo "================================================"
        echo "PR #${{ github.event.pull_request.number }}"
        echo "æ ‡é¢˜: ${{ github.event.pull_request.title }}"
        echo "ä½œè€…: ${{ github.event.pull_request.user.login }}"
        echo "åˆ†æ”¯: ${{ github.event.pull_request.head.ref }}"
        echo "ç›®æ ‡: ${{ github.event.pull_request.base.ref }}"
        echo "================================================"
