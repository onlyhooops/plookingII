name: ğŸ“¦ Release

# å½“æ¨é€æ–°çš„ tag æ—¶è‡ªåŠ¨è§¦å‘å‘å¸ƒæµç¨‹
on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v1.7.1 ç­‰æ ¼å¼

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.7.1)'
        required: true
        type: string

# å¹³å°è¦æ±‚è¯´æ˜
# âš ï¸ æœ¬é¡¹ç›®æ˜¯ macOS x86 ä¸“ç”¨åº”ç”¨
# - æ„å»ºå¿…é¡»åœ¨ macOS Intel (x86_64) ä¸Šè¿›è¡Œ
# - ä½¿ç”¨ PyObjCã€AppKitã€Quartz ç­‰ macOS åŸç”Ÿæ¡†æ¶
# - ä¸æ”¯æŒè·¨å¹³å°æ„å»º

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

jobs:
  # ============================================================================
  # æ„å»ºå’Œå‘å¸ƒ macOS åº”ç”¨
  # ============================================================================
  build-and-release:
    name: ğŸš€ æ„å»ºå¹¶å‘å¸ƒ macOS åº”ç”¨
    runs-on: macos-13  # Intel x86_64 æ¶æ„

    steps:
      # ------------------------------------------------------------------------
      # å‡†å¤‡ç¯å¢ƒ
      # ------------------------------------------------------------------------
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

      - name: ğŸ è®¾ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ” éªŒè¯ç³»ç»Ÿæ¶æ„
        run: |
          echo "ğŸ“Š ç³»ç»Ÿä¿¡æ¯:"
          uname -a
          echo ""
          echo "ğŸ”§ CPU æ¶æ„:"
          uname -m
          echo ""
          echo "ğŸ macOS ç‰ˆæœ¬:"
          sw_vers

      # ------------------------------------------------------------------------
      # è·å–ç‰ˆæœ¬ä¿¡æ¯
      # ------------------------------------------------------------------------
      - name: ğŸ“Œ è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          else
            # ä» tag ä¸­æå–ç‰ˆæœ¬å· (å»æ‰ v å‰ç¼€)
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: $VERSION"

      - name: âœ… éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§
        run: |
          echo "ğŸ” éªŒè¯ç‰ˆæœ¬å·..."
          EXPECTED_VERSION="${{ steps.get_version.outputs.version }}"
          ACTUAL_VERSION=$(python -c "from plookingII.__version__ import __version__; print(__version__)")

          echo "æœŸæœ›ç‰ˆæœ¬: $EXPECTED_VERSION"
          echo "å®é™…ç‰ˆæœ¬: $ACTUAL_VERSION"

          if [ "$EXPECTED_VERSION" != "$ACTUAL_VERSION" ]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬å·ä¸åŒ¹é…ï¼"
            echo "è¯·ç¡®ä¿ plookingII/__version__.py ä¸­çš„ç‰ˆæœ¬å·ä¸ tag ä¸€è‡´"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"

      # ------------------------------------------------------------------------
      # å®‰è£…ä¾èµ–
      # ------------------------------------------------------------------------
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¥ å‡çº§ pip..."
          python -m pip install --upgrade pip

          echo "ğŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–..."
          pip install -r requirements.txt

          echo "ğŸ“¥ å®‰è£…æ„å»ºå·¥å…·..."
          pip install py2app

      - name: ğŸ” éªŒè¯ macOS æ¡†æ¶
        run: |
          echo "ğŸ” éªŒè¯ PyObjC å’Œ macOS æ¡†æ¶..."
          python -c "import objc; print(f'âœ… PyObjC: {objc.__version__}')"
          python -c "import AppKit; print('âœ… AppKit å¯ç”¨')"
          python -c "import Quartz; print('âœ… Quartz å¯ç”¨')"
          python -c "import Cocoa; print('âœ… Cocoa å¯ç”¨')"

      # ------------------------------------------------------------------------
      # æ„å»ºåº”ç”¨
      # ------------------------------------------------------------------------
      - name: ğŸ”¨ æ„å»º macOS åº”ç”¨
        run: |
          echo "ğŸ“¦ å¼€å§‹æ„å»ºåº”ç”¨..."
          python tools/package_release.py --build

          echo "âœ… æ„å»ºå®Œæˆ"
          ls -lh dist/

      - name: ğŸ“¦ æ‰“åŒ…åº”ç”¨
        run: |
          echo "ğŸ—œï¸ åˆ›å»ºå‘å¸ƒå‹ç¼©åŒ…..."
          python tools/package_release.py --package

          echo "âœ… æ‰“åŒ…å®Œæˆ"
          ls -lh release/

      # ------------------------------------------------------------------------
      # ç”Ÿæˆå‘å¸ƒè¯´æ˜
      # ------------------------------------------------------------------------
      - name: ğŸ“ ç”Ÿæˆ Changelog
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # æ£€æŸ¥æ˜¯å¦æœ‰ CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # æå–å½“å‰ç‰ˆæœ¬çš„ changelog
            CHANGELOG=$(awk "/## \[?$VERSION\]?/,/## \[?[0-9]+\.[0-9]+\.[0-9]+\]?/" CHANGELOG.md | sed '1d;$d')

            if [ -z "$CHANGELOG" ]; then
              echo "âš ï¸ æœªåœ¨ CHANGELOG.md ä¸­æ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„æ›´æ–°æ—¥å¿—"
              CHANGELOG="è¯¦è§ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° CHANGELOG.md æ–‡ä»¶"
            CHANGELOG="è¯¦è§é¡¹ç›®æ–‡æ¡£"
          fi

          # ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆGitHub Actions ä¸æ”¯æŒå¤šè¡Œè¾“å‡ºå˜é‡ï¼‰
          echo "$CHANGELOG" > /tmp/changelog.txt

          echo "ğŸ“ Changelog å·²ç”Ÿæˆ"

      - name: ğŸ“‹ å‡†å¤‡å‘å¸ƒè¯´æ˜
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          cat > /tmp/release_notes.md << 'EOF'
          # PlookingII v$VERSION

          ## ğŸ“¦ ä¸‹è½½è¯´æ˜

          **æ”¯æŒå¹³å°**: macOS Intel (x86_64)

          1. ä¸‹è½½ `PlookingII-v$VERSION-macOS-x86_64.zip`
          2. è§£å‹å¾—åˆ° `PlookingII.app`
          3. æ‹–æ‹½åˆ°"åº”ç”¨ç¨‹åº"æ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œéœ€åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸

          ## ğŸ” æ ¡éªŒå’ŒéªŒè¯

          ```bash
          shasum -a 256 -c PlookingII-v$VERSION-macOS-x86_64.zip.sha256
          ```

          ## ğŸ“ æ›´æ–°å†…å®¹

          EOF

          # æ›¿æ¢ç‰ˆæœ¬å·
          sed -i '' "s/\$VERSION/$VERSION/g" /tmp/release_notes.md

          # æ·»åŠ  changelog
          cat /tmp/changelog.txt >> /tmp/release_notes.md

          # æ·»åŠ ç³»ç»Ÿè¦æ±‚
          cat >> /tmp/release_notes.md << 'EOF'

          ## ğŸ’» ç³»ç»Ÿè¦æ±‚

          - **æ“ä½œç³»ç»Ÿ**: macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬
          - **æ¶æ„**: Intel x86_64
          - **å†…å­˜**: å»ºè®® 4GB ä»¥ä¸Š

          ## ğŸ”— ç›¸å…³é“¾æ¥

          - [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/$REPO/blob/main/CHANGELOG.md)
          - [é—®é¢˜åé¦ˆ](https://github.com/$REPO/issues)
          - [é¡¹ç›®æ–‡æ¡£](https://github.com/$REPO#readme)

          ---

          **PlookingII Team** Â© 2025
          EOF

          # æ›¿æ¢ä»“åº“å
          sed -i '' "s|\$REPO|${{ github.repository }}|g" /tmp/release_notes.md

          echo "ğŸ“‹ å‘å¸ƒè¯´æ˜å·²å‡†å¤‡å®Œæˆ"
          cat /tmp/release_notes.md

      # ------------------------------------------------------------------------
      # åˆ›å»º GitHub Release
      # ------------------------------------------------------------------------
      - name: ğŸš€ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: PlookingII ${{ steps.get_version.outputs.tag }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
          files: |
            release/PlookingII-v${{ steps.get_version.outputs.version }}-macOS-x86_64.zip
            release/PlookingII-v${{ steps.get_version.outputs.version }}-macOS-x86_64.zip.sha256
          token: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------------------
      # æ„å»ºæ‘˜è¦
      # ------------------------------------------------------------------------
      - name: ğŸ“Š å‘å¸ƒæ‘˜è¦
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG="${{ steps.get_version.outputs.tag }}"

          echo "## ğŸ‰ å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: $TAG" >> $GITHUB_STEP_SUMMARY
          echo "**å¹³å°**: macOS Intel (x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ å‘å¸ƒäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          ZIP_SIZE=$(ls -lh release/*.zip | awk '{print $5}')
          echo "- **åº”ç”¨å‹ç¼©åŒ…**: PlookingII-v$VERSION-macOS-x86_64.zip ($ZIP_SIZE)" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ¡éªŒå’Œæ–‡ä»¶**: PlookingII-v$VERSION-macOS-x86_64.zip.sha256" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Release é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/$TAG" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # å‘å¸ƒæˆåŠŸé€šçŸ¥
  # ============================================================================
  notify-success:
    name: âœ… å‘å¸ƒæˆåŠŸ
    runs-on: ubuntu-latest
    needs: build-and-release
    if: success()

    steps:
      - name: ğŸ‰ å‘å¸ƒæˆåŠŸ
        run: |
          echo "ğŸ‰ PlookingII ${{ needs.build-and-release.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“¦ Release å·²åˆ›å»ºå¹¶ä¸Šä¼ äº§ç‰©"
          echo "ğŸ”— è®¿é—® https://github.com/${{ github.repository }}/releases æŸ¥çœ‹"
