name: å®‰å…¨æ‰«æ

# ğŸ macOS x86 (Intel) ä¸“ç”¨åº”ç”¨
# æœ¬åº”ç”¨ä½¿ç”¨ PyObjCã€AppKitã€Quartz ç­‰ macOS ä¸“ç”¨æ¡†æ¶
# æ‰€æœ‰ä½œä¸šå¿…é¡»åœ¨ macOS x86 (macos-13) ç¯å¢ƒä¸­è¿è¡Œ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨ä¸€UTCæ—¶é—´0ç‚¹è¿è¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  # ============================================================================
  # ä¾èµ–å®‰å…¨æ‰«æ
  # ============================================================================
  dependency-scan:
    name: ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: macos-13  # macOS x86 (Intel)
    timeout-minutes: 15

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: å®‰è£…Safety
      timeout-minutes: 3
      run: |
        pip install safety

    - name: æ‰«æä¾èµ–æ¼æ´
      timeout-minutes: 5
      run: |
        safety check --file requirements.txt --json > safety-report.json || true
        safety check --file requirements.txt
      continue-on-error: true

    - name: ä¸Šä¼ æŠ¥å‘Š
      uses: actions/upload-artifact@v5
      with:
        name: safety-report
        path: safety-report.json

  # ============================================================================
  # ä»£ç å®‰å…¨æ‰«æ
  # ============================================================================
  code-scan:
    name: ä»£ç å®‰å…¨æ‰«æ
    runs-on: macos-13  # macOS x86 (Intel)
    timeout-minutes: 20

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: å®‰è£…Bandit
      timeout-minutes: 3
      run: |
        pip install bandit[toml]

    - name: è¿è¡ŒBanditæ‰«æ
      timeout-minutes: 10
      run: |
        bandit -r plookingII/ \
          -f json \
          -o bandit-report.json \
          --severity-level medium \
          --confidence-level medium || true
        bandit -r plookingII/ \
          -f screen \
          --severity-level high
      continue-on-error: true

    - name: ä¸Šä¼ BanditæŠ¥å‘Š
      uses: actions/upload-artifact@v5
      with:
        name: bandit-report
        path: bandit-report.json

  # ============================================================================
  # å¯†é’¥æ‰«æ
  # ============================================================================
  secret-scan:
    name: å¯†é’¥æ³„éœ²æ‰«æ
    runs-on: macos-13  # macOS x86 (Intel)
    timeout-minutes: 10

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      timeout-minutes: 3

    - name: TruffleHogæ‰«æ
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
      timeout-minutes: 5
      continue-on-error: true
