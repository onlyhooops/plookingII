name: 安全扫描

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # 每周一UTC时间0点运行
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  # ============================================================================
  # 依赖安全扫描
  # ============================================================================
  dependency-scan:
    name: 依赖安全扫描
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v5
      timeout-minutes: 2
      
    - name: 设置Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: 安装Safety
      timeout-minutes: 3
      run: |
        pip install safety
        
    - name: 扫描依赖漏洞
      timeout-minutes: 5
      run: |
        safety check --file requirements.txt --json > safety-report.json || true
        safety check --file requirements.txt
      continue-on-error: true
      
    - name: 上传报告
      uses: actions/upload-artifact@v4
      with:
        name: safety-report
        path: safety-report.json

  # ============================================================================
  # 代码安全扫描
  # ============================================================================
  code-scan:
    name: 代码安全扫描
    runs-on: macos-latest
    timeout-minutes: 20
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v5
      timeout-minutes: 2
      
    - name: 设置Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: 安装Bandit
      timeout-minutes: 3
      run: |
        pip install bandit[toml]
        
    - name: 运行Bandit扫描
      timeout-minutes: 10
      run: |
        bandit -r plookingII/ \
          -f json \
          -o bandit-report.json \
          --severity-level medium \
          --confidence-level medium || true
        bandit -r plookingII/ \
          -f screen \
          --severity-level high
      continue-on-error: true
      
    - name: 上传Bandit报告
      uses: actions/upload-artifact@v4
      with:
        name: bandit-report
        path: bandit-report.json

  # ============================================================================
  # 密钥扫描
  # ============================================================================
  secret-scan:
    name: 密钥泄露扫描
    runs-on: macos-latest
    timeout-minutes: 10
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
      timeout-minutes: 3
      
    - name: TruffleHog扫描
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
      timeout-minutes: 5
      continue-on-error: true

