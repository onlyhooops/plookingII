# PlookingII 架构文档

## 概述

PlookingII 采用现代化的 MVC (Model-View-Controller) 架构设计，结合模块化开发理念，构建了一个高性能、可维护的 macOS 原生图片浏览器。

**版本**: v1.4.0  
**最后更新**: 2025年9月30日  
**主要特性**: Quartz-only图像处理、自适应性能调优、EXIF方向自动修正、CGImage直通渲染

> **注意**: 本文档已根据项目最新实现进行更新，移除了过时的架构描述，专注于当前稳定版本的技术实现。

## 🆕 v1.0.0 架构更新

### Quartz-only图像处理架构

v1.0.0 实现了完全基于Quartz的图像处理架构，移除了VIPS依赖，统一了图像处理管道，并引入了自适应性能调优系统。

#### 核心架构变更

```
┌─────────────────────────────────────────────────────────────┐
│                    Quartz-only图像处理系统                   │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ ImageManager    │  │ PerformanceMonitor│  │ AdaptiveImageView│ │
│  │  (统一管理)     │  │  (性能监控)      │  │  (CGImage直通)│ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        优化加载策略层                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ OptimizedLoadingStrategy │  │ PreviewLoadingStrategy │  │  │ FastLoadingStrategy │ │
│  │  (智能策略)     │  │  (预览优化)     │  │  (快速加载)  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        Quartz处理层                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ CGImageSource   │  │ EXIF方向处理    │  │ 硬件加速渲染  │ │
│  │  (图像源)       │  │  (自动修正)     │  │  (GPU加速)   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 关键架构改进

##### 1. Quartz-only处理管道
- **统一图像源**: 所有图像处理都通过`CGImageSource`进行
- **EXIF方向自动修正**: 启用`kCGImageSourceCreateThumbnailWithTransform`自动处理方向
- **硬件加速**: 充分利用macOS的GPU加速能力
- **内存映射**: 大文件使用内存映射技术减少内存占用

##### 2. CGImage直通渲染
- **零拷贝渲染**: CGImage直接传递给视图层，避免NSImage包装
- **坐标系优化**: 移除不必要的坐标系变换，直接绘制正确方向的图像
- **性能提升**: 减少图像转换开销，提升渲染性能

##### 3. 自适应性能调优系统
- **实时监控**: `UnifiedMonitor`持续监控应用性能
- **动态调整**: 根据性能分数自动调整解码并发度和预加载窗口
- **参数回滚**: 性能恢复时自动回滚到默认参数
- **内存分级**: 基于系统内存状态的分级优化策略

#### 核心组件说明

##### ImageManager (图像管理器)
- **职责**: 统一图像加载和显示管理
- **功能**:
  - Quartz-only图像加载策略
  - 自适应性能参数调整
  - CGImage直通到视图层
  - 后台线程安全处理
- **设计模式**: 策略模式 + 观察者模式

##### UnifiedMonitor (统一监控器)
- **职责**: 统一管理性能和内存监控
- **功能**:
  - 性能分数计算（0-100）
  - 内存分级检测（低/中/高）
  - 优化建议生成
  - 参数动态调整
- **设计模式**: 单例模式 + 策略模式

##### OptimizedLoadingStrategy (优化加载策略)
- **职责**: 智能图像加载策略选择
- **功能**:
  - 基于文件大小的策略选择
  - 内存映射大文件处理
  - EXIF方向自动处理
  - CGImage直通支持
- **设计模式**: 策略模式 + 工厂模式

##### AdaptiveImageView (自适应图像视图)
- **职责**: 高性能图像显示
- **功能**:
  - CGImage直接绘制
  - 自适应缩放和平移
  - 坐标系优化
  - 交互响应
- **设计模式**: 装饰器模式

#### 性能优化策略

##### 1. 图像加载优化
- **内存映射**: 大文件使用`mmap`减少内存占用
- **缩略图生成**: 智能缩略图尺寸计算和缓存
- **并发控制**: 动态调整解码并发度
- **预加载窗口**: 基于性能的自适应预加载

##### 2. 渲染优化
- **CGImage直通**: 避免NSImage包装开销
- **坐标系简化**: 移除不必要的变换计算
- **硬件加速**: 充分利用GPU渲染能力
- **缓存优化**: 多层缓存架构

##### 3. 内存管理
- **分级管理**: 基于系统内存状态的分级策略
- **自动清理**: 性能压力下的自动缓存清理
- **内存监控**: 实时内存使用监控
- **垃圾回收**: 主动内存回收机制

#### 安全机制

##### 1. 线程安全
- **主线程调度**: 使用`NSOperationQueue.mainQueue()`安全调度UI更新
- **后台处理**: 图像加载在后台线程进行
- **锁机制**: 关键资源的线程安全访问
- **异常处理**: 完善的异常捕获和恢复

##### 2. 内存安全
- **内存压力检测**: 实时监控系统内存状态
- **自动降级**: 内存不足时自动降级处理策略
- **资源清理**: 及时释放不再使用的资源
- **泄漏防护**: 防止内存泄漏的机制

##### 3. 错误恢复
- **优雅降级**: 处理失败时的优雅降级
- **重试机制**: 关键操作的重试机制
- **状态恢复**: 异常后的状态恢复
- **用户友好**: 用户友好的错误提示

## 🆕 v5.0.0 架构更新

### 图片旋转功能架构

v5.0.0 引入了全新的图片旋转功能，采用模块化设计，集成到现有的图像处理管道中。

#### 旋转功能架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    图片旋转功能系统                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ NavigationController │  MainWindow      │  OperationManager │ │
│  │  (键盘事件处理)    │  │  (UI协调)       │  │  (操作管理)   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        图像处理层                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ HybridImageProcessor │  ImageRotationProcessor │  ImageManager │ │
│  │  (混合处理器)      │  │  (旋转处理器)    │  │  (图像管理)   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        处理策略层                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ PIL处理策略      │  │ Quartz处理策略   │  │ 优化处理策略  │ │
│  │  (小文件高质量)  │  │  (大文件性能)    │  │  (内存优化)   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 核心组件说明

##### ImageRotationProcessor (图像旋转处理器)
- **职责**: 专门处理图像旋转操作
- **功能**: 
  - 智能策略选择（PIL vs Quartz）
  - EXIF方向信息处理
  - 旋转质量优化
  - 性能统计和监控
- **设计模式**: 策略模式 + 工厂模式

##### HybridImageProcessor (混合图像处理器)
- **职责**: 集成旋转功能到现有图像处理管道
- **功能**:
  - 旋转功能委托
  - 统计信息管理
  - 缓存协调
- **集成方式**: 组合模式

##### OperationManager (操作管理器)
- **职责**: 管理旋转操作的撤销和重做
- **功能**:
  - 旋转操作记录
  - 撤销栈管理
  - 操作历史跟踪
- **设计模式**: 命令模式

##### NavigationController (导航控制器)
- **职责**: 处理键盘事件和快捷键
- **功能**:
  - 防递归机制
  - 快捷键处理
  - 后台线程执行
- **安全机制**: 防递归标志 + 异常处理

#### 处理策略

##### PIL处理策略
- **适用场景**: 小文件 (< 10MB)
- **优势**: 最高质量，完整EXIF支持
- **算法**: LANCZOS重采样
- **质量**: 95% JPEG质量

##### Quartz处理策略
- **适用场景**: 大文件 (≥ 10MB)
- **优势**: 高性能，内存优化
- **算法**: 硬件加速处理
- **优化**: 流式处理

##### 优化处理策略
- **适用场景**: 超大文件
- **优势**: 内存友好，避免OOM
- **技术**: 分块处理，渐进式加载
- **缓存**: 智能缓存管理

#### 安全机制

##### 防递归机制
- **问题**: 键盘事件处理可能导致无限递归
- **解决方案**: 处理标志 + try-finally
- **实现**: `_processing_key_event` 标志

##### 线程安全
- **问题**: UI线程阻塞
- **解决方案**: 后台线程处理
- **实现**: daemon线程 + 主线程回调

##### 异常处理
- **问题**: 旋转操作可能失败
- **解决方案**: 多层异常捕获
- **实现**: 组件级 + 系统级异常处理

## 🆕 v4.0.0 架构更新

### 基础会话跟踪系统架构

v5.0.0 简化了状态提示系统，移除了趣味功能，保留基础的工作状态跟踪和统计功能。

#### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    基础会话跟踪系统                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ StatusBarController │  SessionManager  │                  │
│  │  (UI集成层)      │  │  (会话管理层)   │                  │
│  └─────────────────┘  └─────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        核心组件层                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ MilestoneTracker │  │  TimerManager   │                  │
│  │  (基础跟踪)      │  │  (定时管理)      │                  │
│  └─────────────────┘  └─────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        配置数据层                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  FunMessagesConfig│  │  TimerConfig     │                  │
│  │  (基础配置)      │  │  (定时配置)      │                  │
│  └─────────────────┘  └─────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

#### 核心组件说明

##### SessionManager (会话管理器)
- **职责**: 管理用户工作会话的基础生命周期
- **功能**:
  - 会话启动、运行、结束管理
  - 工作时长和进度跟踪
  - 基础统计信息收集
  - 工作摘要生成

##### MilestoneTracker (基础跟踪器)
- **职责**: 提供基础的状态跟踪功能
- **功能**:
  - 基础状态跟踪
  - 进度百分比计算
  - 工作时长统计
  - 简化的里程碑结构

# FunMessageGenerator已移除 - 趣味功能已禁用

##### StatusBarController (状态栏控制器)
- **职责**: 集成基础状态跟踪系统到用户界面
- **功能**:
  - 基础状态消息显示和更新
  - 工作统计信息展示
  - 状态栏布局管理
  - 定时器管理

#### 数据流设计

```
用户操作 → 图片管理器 → 会话管理器 → 基础统计计算 → UI显示
    ↓
状态更新 → 定时器触发 → 基础状态更新 → 状态栏更新
```

#### 配置系统

##### 消息配置
- **里程碑配置**: 可自定义的时间、进度、数量里程碑
- **消息模板**: 支持自定义的鼓励、休息、进度等消息内容
- **触发条件**: 可调整的里程碑触发条件和显示参数
- **显示时间**: 可配置的消息显示时间和轮换间隔

##### 休息提醒配置
- **提醒间隔**: 可调整的休息提醒间隔（默认30分钟）
- **最小工作时长**: 最少工作时长才提醒休息（默认30分钟）
- **休息时长建议**: 基于工作时长的休息时长建议
- **用眼休息**: 专门的用眼休息提醒（20分钟间隔）

#### 性能优化策略

##### 轻量级更新
- **状态更新间隔**: 5秒间隔，避免过度频繁的UI更新
- **里程碑检查**: 实时检查，但限制检查频率（5秒内只检查一次）
- **消息轮换**: 智能轮换，避免重复显示相同消息

##### 资源管理
- **内存使用**: 新增功能内存占用 < 1MB
- **CPU使用**: 状态更新CPU占用 < 0.1%
- **启动时间**: 对应用启动时间影响 < 10ms
- **响应性**: 不影响现有操作的响应速度

#### 异常安全设计

##### 错误处理
- **模块级异常**: 每个模块都有完善的异常处理机制
- **优雅降级**: 功能异常时自动降级到基础模式
- **用户友好**: 错误信息对用户友好，不影响正常使用

##### 资源清理
- **定时器管理**: 自动清理定时器，防止内存泄漏
- **会话管理**: 应用关闭时自动清理会话资源
- **状态恢复**: 异常后自动恢复到安全状态

## 架构设计原则

### 1. 职责分离 (Separation of Concerns)
- **视图层 (View)**: 专注于 UI 显示和用户交互
- **控制器层 (Controller)**: 处理用户输入和业务逻辑
- **模型层 (Model)**: 管理数据和业务状态

### 2. 模块化设计 (Modular Design)
- 每个模块独立，职责明确
- 低耦合，高内聚
- 便于测试和维护

### 3. 异常安全 (Exception Safety)
- 完善的异常处理机制
- 优雅的错误恢复
- 用户友好的错误提示

### 4. 性能优化 (Performance Optimization)
- 智能缓存策略
- 后台处理机制
- 内存管理优化

## 架构层次结构

```
┌─────────────────────────────────────────────────────────────┐
│                       应用程序层                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   AppDelegate   │  │   MainWindow    │  │   MenuBar    │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        控制器层                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ ImageViewController │ StatusBarController │ NavigationController │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        管理器层                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  ImageManager   │  │  FolderManager  │  │OperationManager│ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        视图层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ AdaptiveImageView │   OverlayView    │  │ StatusBar    │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        核心层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Cache System  │  │ Image Processing│  │   Threading  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                        服务层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ Recent Service  │  │  DB Service     │  │ Monitor Service│ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 模块详细说明

### 1. 应用程序层 (Application Layer)

#### AppDelegate
- **职责**: 应用程序生命周期管理
- **功能**: 
  - 应用程序启动和关闭
  - 菜单栏管理
  - 系统级事件处理

#### MainWindow
- **职责**: 主窗口管理和协调
- **功能**:
  - 窗口生命周期管理
  - 控制器协调
  - 事件分发

### 2. 控制器层 (Controller Layer)

#### ImageViewController
- **职责**: 图像显示控制
- **功能**:
  - 图像视图管理
  - 缩放控制
  - 显示状态管理

#### StatusBarController
- **职责**: 状态栏管理
- **功能**:
  - 状态信息显示
  - 缩放滑块控制
  - 进度信息更新

#### NavigationController
- **职责**: 导航控制
- **功能**:
  - 键盘事件处理
  - 导航逻辑管理
  - 防抖处理

### 3. 管理器层 (Manager Layer)

#### ImageManager
- **职责**: 图像数据管理
- **功能**:
  - 图像加载策略
  - 缓存管理
  - 图像处理

#### FolderManager
- **职责**: 文件夹管理
- **功能**:
  - 文件夹浏览
  - 历史记录
  - 进度保存

#### OperationManager
- **职责**: 操作管理
- **功能**:
  - 文件操作
  - 撤销/重做
  - 用户交互

### 4. 视图层 (View Layer)

#### AdaptiveImageView
- **职责**: 自适应图像显示
- **功能**:
  - 图像渲染
  - 缩放适配
  - 交互响应

#### OverlayView
- **职责**: 覆盖层显示
- **功能**:
  - 拖拽高亮效果
  - 辅助信息显示
  - 交互反馈

### 5. 核心层 (Core Layer)

#### Cache System
- **职责**: 缓存管理
- **功能**:
  - 多层缓存架构
  - 内存优化
  - 缓存策略

#### Image Processing
- **职责**: 图像处理
- **功能**:
  - 图像加载
  - 格式转换
  - 质量优化

#### Threading
- **职责**: 线程管理
- **功能**:
  - 后台处理
  - 线程池管理
  - 任务调度

### 6. 服务层 (Service Layer)

#### Recent Service
- **职责**: 最近文件管理
- **功能**:
  - 最近文件记录
  - 快速访问
  - 历史管理

#### DB Service
- **职责**: 数据存储
- **功能**:
  - 数据库连接
  - 数据持久化
  - 查询优化

#### Monitor Service
- **职责**: 系统监控
- **功能**:
  - 内存监控
  - 性能监控
  - 资源管理

## 数据流设计

### 1. 用户交互流程

```
用户输入 → 控制器 → 管理器 → 核心层 → 服务层
    ↑                                    ↓
    └────────── 视图更新 ←───────────────┘
```

### 2. 图像加载流程

```
文件选择 → FolderManager → ImageManager → Cache System
    ↑                                        ↓
    └────────── 显示更新 ←── ImageViewController
```

### 3. 缓存管理流程

```
内存压力 → Monitor Service → Cache System → 清理策略
    ↑                                        ↓
    └────────── 性能优化 ←───────────────────┘
```

## 设计模式应用

### 1. MVC 模式
- **Model**: 数据管理层 (Managers + Core)
- **View**: 界面显示层 (Views)
- **Controller**: 控制逻辑层 (Controllers)

### 2. 观察者模式
- 状态变化通知
- 事件驱动更新
- 松耦合通信

### 3. 策略模式
- 图像加载策略
- 缓存清理策略
- 内存管理策略

### 4. 工厂模式
- 图像处理器创建
- 缓存层创建
- 线程池创建

## 性能优化策略

### 1. 缓存优化
- **多层缓存**: 主缓存、预览缓存、预加载缓存
- **智能清理**: 基于使用频率和内存压力的清理策略
- **预测性加载**: 基于用户行为的预加载

### 2. 线程优化
- **后台处理**: 图像处理在后台线程进行
- **线程池**: 复用线程资源，避免频繁创建销毁
- **任务调度**: 智能任务优先级管理

### 3. 内存优化
- **内存监控**: 实时监控内存使用情况
- **自动清理**: 根据内存压力自动清理缓存
- **垃圾回收**: 主动触发垃圾回收

### 4. UI 优化
- **异步更新**: UI 更新在主线程进行
- **批量更新**: 合并多个更新操作
- **延迟加载**: 按需加载 UI 组件

## 扩展性设计

### 1. 插件系统
- 支持自定义图像处理器
- 支持自定义缓存策略
- 支持自定义 UI 组件

### 2. 配置系统
- 灵活的配置管理
- 运行时配置更新
- 用户自定义配置

### 3. 国际化支持
- 多语言界面
- 本地化资源
- 文化适配

## 测试策略

### 1. 单元测试
- 每个模块独立的单元测试
- 边界条件测试
- 异常情况测试

### 2. 集成测试
- 模块间集成测试
- 端到端功能测试
- 性能测试

### 3. 回归测试
- API 签名验证
- 功能回归测试
- 兼容性测试

## 部署架构

### 1. 开发环境
- Python 3.8+
- PyObjC 框架
- 开发工具链

### 2. 生产环境
- macOS 10.15+
- 打包应用
- 系统集成

### 3. 分发策略
- App Store 分发
- 直接下载分发
- 企业内部分发

## 总结

PlookingII 的架构设计充分考虑了现代软件开发的各项要求：

- **可维护性**: 清晰的模块划分和职责分离
- **可扩展性**: 插件化设计和配置系统
- **性能**: 多层次的优化策略
- **稳定性**: 完善的异常处理和错误恢复
- **用户体验**: 响应式设计和流畅交互

这种架构设计为 PlookingII 的长期发展和功能扩展奠定了坚实的基础。
